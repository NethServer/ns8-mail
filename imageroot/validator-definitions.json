{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "http://schema.nethserver.org/mail.json",
    "title": "Common schema definitions",
    "description": "Reusable schema definitions",
    "$defs": {
        "mail-destination": {
            "title": "Mail destination",
            "description": "Final mail destination (both internal and external)",
            "oneOf": [
                {
                    "$ref": "#/$defs/mail-destination-internal"
                },
                {
                    "title": "External mail destination",
                    "type": "object",
                    "required": [
                        "dtype",
                        "name"
                    ],
                    "properties": {
                        "dtype": {
                            "title": "External destination type",
                            "const": "external"
                        },
                        "name": {
                            "title": "External email address",
                            "type": "string",
                            "format": "email",
                            "minLength": 1
                        }
                    }
                }
            ]
        },
        "mail-destination-internal": {
            "examples": [
                {
                    "dtype": "public",
                    "name": "invoices"
                },
                {
                    "dtype": "user",
                    "name": "first.user",
                    "ui_name": "First User"
                },
                {
                    "dtype": "group",
                    "name": "sales",
                    "ui_name": "Sales Department"
                },
                {
                    "dtype": "apo",
                    "name": "eg.deleted.user"
                }
            ],
            "title": "Internal mail destination",
            "description": "Describes where a message ends on the local mail server",
            "type": "object",
            "required": [
                "dtype",
                "name"
            ],
            "properties": {
                "dtype": {
                    "title": "Destination type",
                    "enum": [
                        "user",
                        "group",
                        "public",
                        "apo"
                    ]
                },
                "name": {
                    "title": "Object name",
                    "type": "string",
                    "minLength": 1
                },
                "ui_name": {
                    "title": "Object name for UI",
                    "description": "String representation of the mail destination for display purpose",
                    "type": "string"
                }
            }
        },
        "mail-domain": {
            "examples": [
                {
                    "domain": "dp.nethserver.net",
                    "addusers": true,
                    "addgroups": false,
                    "catchall": null,
                    "bccaddr": null,
                    "description": ""
                },
                {
                    "domain": "company.test",
                    "addusers": true,
                    "addgroups": false,
                    "catchall": null,
                    "bccaddr": null,
                    "description": "Company domain with addusers flag set"
                },
                {
                    "domain": "mydom.test",
                    "addusers": true,
                    "addgroups": false,
                    "catchall": {
                        "dtype": "user",
                        "user": "first.user",
                        "ui_name": "First User"
                    },
                    "bccaddr": "administrator@company.test",
                    "description": ""
                }
            ],
            "title": "Mail domain",
            "description": "Describe how mail for the domain is handled",
            "type": "object",
            "required": [
                "domain"
            ],
            "properties": {
                "domain": {
                    "title": "Mail domain",
                    "description": "The standard-compliant domain name",
                    "format": "idn-hostname",
                    "pattern": "\\."
                },
                "addusers": {
                    "title": "Addusers flag",
                    "description": "Accept user mailbox names as valid mail addresses",
                    "type": "boolean"
                },
                "addgroups": {
                    "title": "Addgroups flag",
                    "description": "Accept LDAP group names as valid mail addresses",
                    "type": "boolean"
                },
                "catchall": {
                    "title": "Catchall mailbox",
                    "description": "Deliver messages for unknown recipients into this mailbox. NULL disables this behavior.",
                    "oneOf": [
                        {
                            "type": "null",
                            "title": "No catchall",
                            "description": "The catchall feature is disabled"
                        },
                        {
                            "$ref": "#/$defs/mail-destination-internal"
                        }
                    ]
                },
                "bccaddr": {
                    "title": "BCC address",
                    "description": "Send a blind carbon copy of domain inbound messages to this email address. NULL disables this behavior.",
                    "type": [
                        "string",
                        "null"
                    ],
                    "format": "email"
                },
                "description": {
                    "title": "Domain description",
                    "description": "Free textual description of the domain purpose",
                    "type": "string"
                }
            }
        },
        "mail-address": {
            "title": "Mail address",
            "description": "An object describing one or more mail addresses known and handled by the mail server",
            "examples": [
                {
                    "local": "postmaster",
                    "destinations": [
                        {
                            "dtype": "public",
                            "public": "postmaster"
                        }
                    ],
                    "description": "RFC-mandatory postmaster alias",
                    "atype": "wildcard",
                    "delete_forbidden": true
                },
                {
                    "local": "info",
                    "destinations": [
                        {
                            "dtype": "user",
                            "user": "admin",
                            "ui_name": "Builtin administrator user"
                        }
                    ],
                    "atype": "domain",
                    "domain": "mydom.test"
                },
                {
                    "local": "sales",
                    "destinations": [
                        {
                            "dtype": "user",
                            "user": "first.user",
                            "ui_name": "First User"
                        }
                    ],
                    "atype": "wildcard"
                },
                {
                    "atype": "adduser",
                    "local": "admin",
                    "description": "Builtin administrator user"
                },
                {
                    "atype": "adduser",
                    "local": "first.user",
                    "description": "First User"
                }
            ],
            "oneOf": [
                {
                    "allOf": [
                        {
                            "$ref": "#/$defs/mail-address-base"
                        },
                        {
                            "title": "Address bound to a domain",
                            "required": [
                                "domain",
                                "destinations"
                            ],
                            "properties": {
                                "atype": {
                                    "const": "domain"
                                }
                            }
                        }
                    ]
                },
                {
                    "allOf": [
                        {
                            "$ref": "#/$defs/mail-address-base"
                        },
                        {
                            "title": "Address bound to any domain",
                            "required": [
                                "destinations"
                            ],
                            "properties": {
                                "atype": {
                                    "const": "wildcard"
                                }
                            }
                        }
                    ]
                },
                {
                    "allOf": [
                        {
                            "$ref": "#/$defs/mail-address-base"
                        },
                        {
                            "title": "Address bound to \"adduser\" domains",
                            "properties": {
                                "atype": {
                                    "const": "adduser"
                                }
                            }
                        }
                    ]
                },
                {
                    "allOf": [
                        {
                            "$ref": "#/$defs/mail-address-base"
                        },
                        {
                            "title": "Address bound to \"addgroup\" domains",
                            "properties": {
                                "atype": {
                                    "const": "addgroup"
                                }
                            }
                        }
                    ]
                }
            ]
        },
        "mail-address-base": {
            "title": "Base mail address schema",
            "description": "Schema included by other more specific schema",
            "type": "object",
            "required": [
                "atype",
                "local"
            ],
            "properties": {
                "description": {
                    "type": "string",
                    "title": "Description"
                },
                "domain": {
                    "type": "string",
                    "title": "Address domain part",
                    "format": "idn-hostname",
                    "pattern": "\\."
                },
                "local": {
                    "type": "string",
                    "title": "Address local part",
                    "minLength": 1
                },
                "atype": {
                    "type": "string",
                    "title": "Address type"
                },
                "destinations": {
                    "type": "array",
                    "minItems": 1,
                    "items": {
                        "$ref": "#/$defs/mail-destination"
                    }
                },
                "delete_forbidden": {
                    "const": true,
                    "title": "Delete forbidden flag",
                    "description": "Do not attempt to remove the object"
                },
                "internal": {
                    "type": "boolean",
                    "title": "Internal",
                    "description": "True, if the address cannot receive mail from external/unknown clients"
                }
            }
        },
        "mail-address-change-request": {
            "title": "Mail address change request",
            "description": "An object describing how to modify an existing mail address object",
            "oneOf": [
                {
                    "allOf": [
                        {
                            "properties": {
                                "atype": {
                                    "const": "domain"
                                }
                            },
                            "required": [
                                "domain"
                            ]
                        },
                        {
                            "$ref": "#/$defs/mail-address-base"
                        }
                    ]
                },
                {
                    "allOf": [
                        {
                            "properties": {
                                "atype": {
                                    "const": "wildcard"
                                }
                            }
                        },
                        {
                            "$ref": "#/$defs/mail-address-base"
                        }
                    ]
                },
                {
                    "allOf": [
                        {
                            "properties": {
                                "atype": {
                                    "const": "adduser"
                                }
                            }
                        },
                        {
                            "$ref": "#/$defs/mail-address-base"
                        }
                    ]
                },
                {
                    "allOf": [
                        {
                            "properties": {
                                "atype": {
                                    "const": "addgroup"
                                }
                            }
                        },
                        {
                            "$ref": "#/$defs/mail-address-base"
                        }
                    ]
                }
            ]
        }
    }
}
